<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ujimatsu-chiya.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"vs","dark":"vs2015"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="article">
<meta property="og:title" content="Project Euler 335">
<meta property="og:url" content="https://ujimatsu-chiya.github.io/project-euler/335/index.html">
<meta property="og:site_name" content="Ujimatsu Chiya">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ujimatsu-chiya.github.io/project-euler/resources/images/0335_mancala.gif">
<meta property="article:published_time" content="2026-01-13T15:52:37.000Z">
<meta property="article:modified_time" content="2026-01-13T16:20:23.014Z">
<meta property="article:author" content="Ujimatsu Chiya">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ujimatsu-chiya.github.io/project-euler/resources/images/0335_mancala.gif">


<link rel="canonical" href="https://ujimatsu-chiya.github.io/project-euler/335/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://ujimatsu-chiya.github.io/project-euler/335/","path":"project-euler/335/","title":"Project Euler 335"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Project Euler 335 | Ujimatsu Chiya</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js" defer></script>
  <script async src="https://hm.baidu.com/hm.js?b51c0caaa35b7e7749207556edb4b772"></script>







  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/pjax.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>




  <script src="/js/third-party/fancybox.js" defer></script>



  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Ujimatsu Chiya</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-project-euler"><a href="/project-euler/" rel="section"><i class="fa fa-align-justify fa-fw"></i>Project Euler</a></li><li class="menu-item menu-item-算法导论"><a href="/introduction-to-algorithms/" rel="section"><i class="fa-solid fa-question fa-fw"></i>算法导论</a></li><li class="menu-item menu-item-友情链接"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友情链接</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#project-euler-335"><span class="nav-number">1.</span> <span class="nav-text">Project Euler 335</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE"><span class="nav-number">1.1.</span> <span class="nav-text">题目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#gathering-the-beans"><span class="nav-number">1.1.1.</span> <span class="nav-text">Gathering the beans</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81"><span class="nav-number">1.3.</span> <span class="nav-text">代码</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ujimatsu Chiya"
      src="/images/chiya.png">
  <p class="site-author-name" itemprop="name">Ujimatsu Chiya</p>
  <div class="site-description" itemprop="description">Ujimatsu Chiya 的博客还在建造当中，什么都会整一些上来哦</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">773</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Ujimatsu-Chiya" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Ujimatsu-Chiya" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://leetcode.cn/u/ujimatsu_chiya/" title="Leetcode → https:&#x2F;&#x2F;leetcode.cn&#x2F;u&#x2F;ujimatsu_chiya&#x2F;" rel="noopener me" target="_blank"><i class="fa custom leetcode fa-fw"></i>Leetcode</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.xiaohongshu.com/user/profile/6423968900000000110225fd" title="Xiaohongshu → https:&#x2F;&#x2F;www.xiaohongshu.com&#x2F;user&#x2F;profile&#x2F;6423968900000000110225fd" rel="noopener me" target="_blank"><i class="fa custom xiaohongshu fa-fw"></i>Xiaohongshu</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ujimatsu-chiya.github.io/project-euler/335/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/chiya.png">
      <meta itemprop="name" content="Ujimatsu Chiya">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ujimatsu Chiya">
      <meta itemprop="description" content="Ujimatsu Chiya 的博客还在建造当中，什么都会整一些上来哦">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Project Euler 335 | Ujimatsu Chiya">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Project Euler 335
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-13 23:52:37" itemprop="dateCreated datePublished" datetime="2026-01-13T23:52:37+08:00">2026-01-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-14 00:20:23" itemprop="dateModified" datetime="2026-01-14T00:20:23+08:00">2026-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Project-Euler/" itemprop="url" rel="index"><span itemprop="name">Project Euler</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><escape><span id="more"></span></escape></p>
<h1 id="project-euler-335">Project Euler 335</h1>
<h2 id="题目">题目</h2>
<h3 id="gathering-the-beans">Gathering the beans</h3>
<p>Whenever Peter feels bored, he places some bowls, containing one bean
each, in a circle. After this, he takes all the beans out of a certain
bowl and drops them one by one in the bowls going clockwise. He repeats
this, starting from the bowl he dropped the last bean in, until the
initial situation appears again. For example with <span
class="math inline">\(5\)</span> bowls he acts as follows:</p>
<p><img data-src="../resources/images/0335_mancala.gif" /></p>
<p>So with <span class="math inline">\(5\)</span> bowls it takes Peter
<span class="math inline">\(15\)</span> moves to return to the initial
situation.</p>
<p>Let <span class="math inline">\(M(x)\)</span> represent the number of
moves required to return to the initial situation, starting with <span
class="math inline">\(x\)</span> bowls. Thus, <span
class="math inline">\(M(5) = 15\)</span>. It can also be verified that
<span class="math inline">\(M(100) = 10920\)</span>.</p>
<p>Find <span class="math inline">\(\displaystyle \sum_{k=0}^{10^{18}}
M(2^k + 1)\)</span>. Give your answer modulo <span
class="math inline">\(7^9\)</span>.</p>
<h2 id="解决方案">解决方案</h2>
<p>设某一步操作把分布变成全 <span
class="math inline">\(1\)</span>。这一操作来自某个碗 <span
class="math inline">\(p\)</span>，取出 <span
class="math inline">\(t=x_p\)</span> 颗豆子并依次放到后面 <span
class="math inline">\(t\)</span> 个碗。要让操作后每个碗都是 <span
class="math inline">\(1\)</span>，注意：</p>
<ul>
<li>被取走的碗 <span class="math inline">\(p\)</span> 操作后是 <span
class="math inline">\(0\)</span>，因此它必须在撒豆过程中也被加到一次，即撒豆必须绕圈覆盖到
<span class="math inline">\(p\)</span> 本身；</li>
<li>每个碗最终要加到 <strong>恰好一次</strong>，否则不会都变成 <span
class="math inline">\(1\)</span>。</li>
</ul>
<p>因此撒豆必须覆盖整整一圈的 <span class="math inline">\(n\)</span>
个碗，每个碗加 <span class="math inline">\(1\)</span>
一次，故必须有<span
class="math inline">\(t=n.\)</span>而在该步开始之前，被撒到的每个碗都会被加
<span class="math inline">\(1\)</span>，要最终变成 <span
class="math inline">\(1\)</span>，它们之前必须是 <span
class="math inline">\(0\)</span>。同时出发碗 <span
class="math inline">\(p\)</span> 之前必须有 <span
class="math inline">\(n\)</span>
颗豆子。于是“最后一步之前”的分布必然是：<strong>恰有一个碗里有 <span
class="math inline">\(n\)</span> 颗豆子，其余 <span
class="math inline">\(n-1\)</span> 个碗全为 <span
class="math inline">\(0\)</span>。</strong> 最后一步把这 <span
class="math inline">\(n\)</span> 颗豆子均匀撒一圈，回到全 <span
class="math inline">\(1\)</span>。</p>
<p>下面固定<span class="math inline">\(n=2^k+1, N=n-1=2^k.\)</span></p>
<p>虽然 <span class="math inline">\(M(n)\)</span>
不要求“当前位置”回到起点，但为了分析方便，我们约定从碗 <span
class="math inline">\(p=0\)</span> 开始，跟踪当前位置 <span
class="math inline">\(p\)</span>。观察一个现象：当 <span
class="math inline">\(p\)</span> 再次变回 <span
class="math inline">\(0\)</span>
时，可以把过程自然切成若干段（称为一轮）。</p>
<ul>
<li>第 <span class="math inline">\(r\)</span> 轮：从某次 <span
class="math inline">\(p=0\)</span>（轮开始）起，直到下一次 <span
class="math inline">\(p=0\)</span>（下一轮开始）为止；</li>
<li>注意：最后一轮的结束点是“分布回到全 <span
class="math inline">\(1\)</span>”那一刻（此时 <span
class="math inline">\(p\)</span> 不一定是 <span
class="math inline">\(0\)</span>）。</li>
</ul>
<p>在 <span class="math inline">\(n=2^k+1\)</span>
的情形，实验现象非常稳定且可归纳证明：<strong>一共正好有 <span
class="math inline">\(N=2^k\)</span>
轮</strong>。更具体地，在每一轮开始时：</p>
<ul>
<li>碗 <span class="math inline">\(0\)</span> 里恰好是 <span
class="math inline">\(1\)</span>；</li>
<li>最后一个碗 <span class="math inline">\(n-1\)</span> 里的豆子数会从
<span class="math inline">\(1\)</span> 逐轮增长到 <span
class="math inline">\(N\)</span>，也就是第 <span
class="math inline">\(r\)</span> 轮开始时，碗 <span
class="math inline">\(n-1\)</span> 中有 <span
class="math inline">\(r+1\)</span> 颗豆子（<span
class="math inline">\(r=0,1,\dots,N-1\)</span>）。</li>
</ul>
<p>直观解释：每一轮从 <span class="math inline">\(p=0\)</span>
出发，最终会发生一次“绕回到 <span
class="math inline">\(0\)</span>”的跨界，这一次跨界恰好会让最后一个碗多得到
<span class="math inline">\(1\)</span> 颗豆子；因为总豆子数固定为 <span
class="math inline">\(n=N+1\)</span>，当最后一个碗增长到 <span
class="math inline">\(N\)</span> 时，其余碗只剩下碗 <span
class="math inline">\(0\)</span> 的那 <span
class="math inline">\(1\)</span> 颗豆子，下一轮会把这 <span
class="math inline">\(1\)</span> 颗也逐步推进，最终形成“某个碗有 <span
class="math inline">\(n\)</span> 颗，其余为 <span
class="math inline">\(0\)</span>”并完成最后一步回到全 <span
class="math inline">\(1\)</span>。</p>
<p>于是 <span class="math inline">\(M(n)\)</span>
就等于所有轮长之和：<span
class="math inline">\(\displaystyle{M(2^k+1)=\sum_{r=0}^{2^k-1}
\ell_k(r),}\)</span>其中 <span class="math inline">\(\ell_k(r)\)</span>
是第 <span class="math inline">\(r\)</span> 轮的操作次数（轮长）。</p>
<p>定义“缺口”（表示和<span
class="math inline">\(n\)</span>的相比，少走的步数）<span
class="math inline">\(d_k(r)=n-\ell_k(r).\)</span>从大量小 <span
class="math inline">\(k\)</span> 的展开可以发现并可用归纳法证明：对
<span class="math inline">\(n=2^k+1\)</span>，所有缺口 <span
class="math inline">\(d_k(r)\)</span> 都是 <span
class="math inline">\(0\)</span> 或 <span
class="math inline">\(2\)</span>
的幂，并且整列缺口有严格的自相似递推。递推写成序列形式最清晰。记缺口序列为
<span class="math display">\[
\mathbf{d}_k=(d_k(0),d_k(1),\dots,d_k(2^k-1)).
\]</span> 直接由过程“从 <span class="math inline">\(2^{k-1}+1\)</span>
扩到 <span
class="math inline">\(2^k+1=2(2^{k-1}+1)-1\)</span>”的结构（把圆在碗
<span class="math inline">\(0\)</span> 处切开、比较“轮内不回到 <span
class="math inline">\(0\)</span>
的前进段”在两种规模下的对应关系）可得到：</p>
<ul>
<li>基础：当 <span class="math inline">\(k=1\)</span>（<span
class="math inline">\(n=3\)</span>）时两轮长度是 <span
class="math inline">\((2,3)\)</span>，故<span
class="math inline">\(\mathbf{d}_1=(1,0).\)</span></li>
<li>递推：对 <span class="math inline">\(k\ge 2\)</span>，令 <span
class="math inline">\(m=2^{k-1}\)</span>。则<span
class="math inline">\(\mathbf{d}_k=(2d_{k-1}(0),2d_{k-1}(1),\dots,2d_{k-1}(m-2),m,d_{k-1}(0),d_{k-1}(1),\dots,d_{k-1}(m-1)).\)</span>
也就是说：前半段（除去一个特殊位置）把旧缺口乘 <span
class="math inline">\(2\)</span>，中间插入一个缺口 <span
class="math inline">\(2^{k-1}\)</span>，后半段原样复制旧缺口。</li>
</ul>
<p>这个递推与真实过程一一对应：前半段轮的“回到 <span
class="math inline">\(0\)</span>”发生得更早，因此轮长相对于 <span
class="math inline">\(n\)</span> 的缺口会被放大；当轮序达到 <span
class="math inline">\(2^{k-1}-1\)</span>
时发生一次“正好跨过半圈”的特殊回返，对应插入缺口 <span
class="math inline">\(2^{k-1}\)</span>；之后进入后半段，过程在结构上等价于规模
<span class="math inline">\(k-1\)</span>
的继续推进，因此缺口原样重复。</p>
<p>令<span class="math inline">\(\displaystyle{D_k=\sum_{r=0}^{2^k-1}
d_k(r)}\)</span>为缺口总和。由上面的序列递推，直接对总和求递推（注意
<span class="math inline">\(\mathbf{d}_{k-1}\)</span> 的最后一个元素总为
<span class="math inline">\(0\)</span>，因此“前半段乘 <span
class="math inline">\(2\)</span>
且少一项”的细节不会带来额外麻烦）可得：<span
class="math inline">\(\displaystyle{D_k = 2\sum_{r=0}^{2^{k-1}-2}
d_{k-1}(r)+2^{k-1}+\sum_{r=0}^{2^{k-1}-1} d_{k-1}(r)=
3D_{k-1}+2^{k-1},}\)</span>并且 <span
class="math inline">\(D_1=1\)</span>。</p>
<p>解这个一阶递推：<span
class="math inline">\(D_k-3D_{k-1}=2^{k-1}n\)</span>可得<span
class="math inline">\(D_k=3^k-2^k.\)</span></p>
<p>另一方面，由定义 <span
class="math inline">\(d_k(r)=n-\ell_k(r)\)</span>，并且一共有 <span
class="math inline">\(2^k\)</span> 轮，并且有<span
class="math inline">\(\displaystyle{\sum_{r=0}^{2^k-1}\ell_k(r)=2^k\cdot
n - D_k.}\)</span> 代入 <span class="math inline">\(n=2^k+1\)</span> 与
<span class="math inline">\(D_k=3^k-2^k\)</span>，得到</p>
<p><span class="math display">\[
M(2^k+1)=2^k(2^k+1)-(3^k-2^k)
=4^k+2^{k+1}-3^k.
\]</span></p>
<p>最终所求结果为</p>
<p><span class="math display">\[
\sum_{k=0}^{N}
M(2^k+1)=\sum_{k=0}^{N}(4^k+2^{k+1}-3^k)=\dfrac{4^{N+1}-1}{3} +
(2^{N+2}-2) - \dfrac{3^{N+1}-1}{2}.
\]</span></p>
<p>因为 <span
class="math inline">\(\gcd(2,M)=\gcd(3,M)=1\)</span>，所以在模 <span
class="math inline">\(M\)</span> 下 <span
class="math inline">\(2,3\)</span> 都可逆，直接用模逆元即可。</p>
<h2 id="代码">代码</h2>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">N = <span class="number">10</span> ** <span class="number">18</span></span><br><span class="line">mod = <span class="number">7</span> ** <span class="number">9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inv2 = <span class="built_in">pow</span>(<span class="number">2</span>, -<span class="number">1</span>, mod)</span><br><span class="line">inv3 = <span class="built_in">pow</span>(<span class="number">3</span>, -<span class="number">1</span>, mod)</span><br><span class="line"></span><br><span class="line">term1 = (<span class="built_in">pow</span>(<span class="number">4</span>, N + <span class="number">1</span>, mod) - <span class="number">1</span>) * inv3 % mod  <span class="comment"># (4^(N+1)-1)/3</span></span><br><span class="line">term2 = (<span class="built_in">pow</span>(<span class="number">2</span>, N + <span class="number">2</span>, mod) - <span class="number">2</span>) % mod  <span class="comment"># 2^(N+2)-2</span></span><br><span class="line">term3 = (<span class="built_in">pow</span>(<span class="number">3</span>, N + <span class="number">1</span>, mod) - <span class="number">1</span>) * inv2 % mod  <span class="comment"># (3^(N+1)-1)/2</span></span><br><span class="line"></span><br><span class="line">ans = (term1 + term2 - term3) % mod</span><br><span class="line"><span class="built_in">print</span>(ans)</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="Ujimatsu Chiya 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="Ujimatsu Chiya 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Ujimatsu Chiya
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://ujimatsu-chiya.github.io/project-euler/335/" title="Project Euler 335">https://ujimatsu-chiya.github.io/project-euler/335/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2022 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Ujimatsu Chiya</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">25:03</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div><!-- 页面动态线条-->
<script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://lib.baomitu.com/canvas-nest.js/1.0.1/canvas-nest.js"></script>
<!-- 页面点击小红心
<script type="text/javascript" src="/js/click-love.js" />-->

<span id="sitetime"></span>
<script language=javascript>
function siteTime(){
    window.setTimeout("siteTime()", 1000);
    let seconds = 1000;
    let minutes = seconds * 60;
    let hours = minutes * 60;
    let days = hours * 24;
    let years = days * 365;
    let create_day = new Date("2022-03-25T13:14:23Z");
    let today = new Date();
    let awesome = "<i class=\"fa-solid fa-clock\"></i> "

    let diff = today-create_day;
    let diffSeconds = Math.floor(diff/seconds%60);
    let diffMinutes = Math.floor(diff/minutes%60);
    let diffHours = Math.floor(diff/hours%24);
    let diffDays = Math.floor(diff/days%365);
    let diffYears = Math.floor(diff/years);

    document.getElementById("sitetime").innerHTML=`自 ${create_day.getFullYear()} 年 ${create_day.getMonth() + 1} 月 ${create_day.getDate()} 日建立以来，本网站已运行： ${awesome} ${diffYears} 年 ${diffDays} 天 ${diffHours} 时 ${diffMinutes} 分 ${diffSeconds} 秒`;
}
siteTime();
</script>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"Ujimatsu-Chiya/Ujimatsu-Chiya.github.io-comment","issue_term":"pathname","theme":"github-light","crossorigin":"anonymous"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
