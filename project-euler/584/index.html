<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ujimatsu-chiya.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"vs","dark":"vs2015"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="article">
<meta property="og:title" content="Project Euler 584">
<meta property="og:url" content="https://ujimatsu-chiya.github.io/project-euler/584/index.html">
<meta property="og:site_name" content="Ujimatsu Chiya">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2026-01-21T11:56:33.000Z">
<meta property="article:modified_time" content="2026-01-21T11:56:33.726Z">
<meta property="article:author" content="Ujimatsu Chiya">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ujimatsu-chiya.github.io/project-euler/584/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://ujimatsu-chiya.github.io/project-euler/584/","path":"project-euler/584/","title":"Project Euler 584"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Project Euler 584 | Ujimatsu Chiya</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js" defer></script>
  <script async src="https://hm.baidu.com/hm.js?b51c0caaa35b7e7749207556edb4b772"></script>







  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/pjax.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>




  <script src="/js/third-party/fancybox.js" defer></script>



  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Ujimatsu Chiya</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-project-euler"><a href="/project-euler/" rel="section"><i class="fa fa-align-justify fa-fw"></i>Project Euler</a></li><li class="menu-item menu-item-算法导论"><a href="/introduction-to-algorithms/" rel="section"><i class="fa-solid fa-question fa-fw"></i>算法导论</a></li><li class="menu-item menu-item-友情链接"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友情链接</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#project-euler-584"><span class="nav-number">1.</span> <span class="nav-text">Project Euler 584</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE"><span class="nav-number">1.1.</span> <span class="nav-text">题目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#birthday-problem-revisited"><span class="nav-number">1.1.1.</span> <span class="nav-text">Birthday Problem Revisited</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81"><span class="nav-number">1.3.</span> <span class="nav-text">代码</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ujimatsu Chiya"
      src="/images/chiya.png">
  <p class="site-author-name" itemprop="name">Ujimatsu Chiya</p>
  <div class="site-description" itemprop="description">Ujimatsu Chiya 的博客还在建造当中，什么都会整一些上来哦</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">773</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Ujimatsu-Chiya" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Ujimatsu-Chiya" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://leetcode.cn/u/ujimatsu_chiya/" title="Leetcode → https:&#x2F;&#x2F;leetcode.cn&#x2F;u&#x2F;ujimatsu_chiya&#x2F;" rel="noopener me" target="_blank"><i class="fa custom leetcode fa-fw"></i>Leetcode</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.xiaohongshu.com/user/profile/6423968900000000110225fd" title="Xiaohongshu → https:&#x2F;&#x2F;www.xiaohongshu.com&#x2F;user&#x2F;profile&#x2F;6423968900000000110225fd" rel="noopener me" target="_blank"><i class="fa custom xiaohongshu fa-fw"></i>Xiaohongshu</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ujimatsu-chiya.github.io/project-euler/584/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/chiya.png">
      <meta itemprop="name" content="Ujimatsu Chiya">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ujimatsu Chiya">
      <meta itemprop="description" content="Ujimatsu Chiya 的博客还在建造当中，什么都会整一些上来哦">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Project Euler 584 | Ujimatsu Chiya">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Project Euler 584
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-21 19:56:33" itemprop="dateCreated datePublished" datetime="2026-01-21T19:56:33+08:00">2026-01-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Project-Euler/" itemprop="url" rel="index"><span itemprop="name">Project Euler</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><escape><span id="more"></span></escape></p>
<h1 id="project-euler-584">Project Euler 584</h1>
<h2 id="题目">题目</h2>
<h3 id="birthday-problem-revisited">Birthday Problem Revisited</h3>
<p>A long long time ago in a galaxy far far away, the Wimwians,
inhabitants of planet WimWi, discovered an unmanned drone that had
landed on their planet. On examining the drone, they uncovered a device
that sought the answer for the so called “<strong>Birthday
Problem</strong>”. The description of the problem was as follows:</p>
<p><em>If people on your planet were to enter a very large room one by
one, what will be the expected number of people in the room when you
first find <strong><span class="math inline">\(\mathbf{3}\)</span>
people with Birthdays within <span
class="math inline">\(\mathbf{1}\)</span> day from each
other</strong>.</em></p>
<p>The description further instructed them to enter the answer into the
device and send the drone into space again. Startled by this turn of
events, the Wimwians consulted their best mathematicians. Each year on
Wimwi has <span class="math inline">\(10\)</span> days and the
mathematicians assumed equally likely birthdays and ignored leap years
(leap years in Wimwi have <span class="math inline">\(11\)</span> days),
and found <span class="math inline">\(5.78688636\)</span> to be the
required answer. As such, the Wimwians entered this answer and sent the
drone back into space.</p>
<p>After traveling light years away, the drone then landed on planet
Joka. The same events ensued except this time, the numbers in the device
had changed due to some unknown technical issues. The description
read:</p>
<p><em>If people on your planet were to enter a very large room one by
one, what will be the expected number of people in the room when you
first find <strong><span class="math inline">\(\mathbf{3}\)</span>
people with Birthdays within <span
class="math inline">\(\mathbf{7}\)</span> days from each
other</strong>.</em></p>
<p>With a <span class="math inline">\(100\)</span>-day year on the
planet, the Jokars (inhabitants of Joka) found the answer to be <span
class="math inline">\(8.48967364\)</span> (rounded to <span
class="math inline">\(8\)</span> decimal places because the device
allowed only <span class="math inline">\(8\)</span> places after the
decimal point) assuming equally likely birthdays. They too entered the
answer into the device and launched the drone into space again.</p>
<p>This time the drone landed on planet Earth. As before the numbers in
the problem description had changed. It read:</p>
<p><em>If people on your planet were to enter a very large room one by
one, what will be the expected number of people in the room when you
first find <strong><span class="math inline">\(\mathbf{4}\)</span>
people with Birthdays within <span
class="math inline">\(\mathbf{7}\)</span> days from each
other</strong>.</em></p>
<p>What would be the answer (rounded to eight places after the decimal
point) the people of Earth have to enter into the device for a year with
<span class="math inline">\(365\)</span> days? Ignore leap years. Also
assume that all birthdays are equally likely and independent of each
other.</p>
<h2 id="解决方案">解决方案</h2>
<p>简而言之，题目是说一年共有 <span class="math inline">\(Y=365\)</span>
天，生日均匀独立分布在 <span
class="math inline">\({0,1,\dots,Y-1}\)</span>
上，并按圆环距离定义相隔不超过 <span class="math inline">\(w=7\)</span>
天。</p>
<p>题目要求的触发条件是：存在 <strong><span
class="math inline">\(K=4\)</span></strong>
个人，他们的生日都落在某个长度为 <strong><span
class="math inline">\(w+1\)</span></strong>
的连续区间内（按圆环取模）。</p>
<p>记随机变量 <span class="math inline">\(N\)</span>
为<strong>第一个触发条件出现时，房间里的人数</strong>，求 <span
class="math inline">\(\mathbb E[N]\)</span>。</p>
<p>设事件 <span class="math inline">\(B_n\)</span> 表示“前 <span
class="math inline">\(n\)</span> 个人中尚未出现触发条件”，则</p>
<ul>
<li><span class="math inline">\(\mathbb P(N&gt;n)=\mathbb
P(B_n)\)</span></li>
<li><span class="math inline">\(\mathbb P(N=n)=\mathbb
P(B_{n-1})-\mathbb P(B_n)\)</span></li>
</ul>
<p>于是<span class="math inline">\(\displaystyle{\mathbb
E[N]=\sum_{n\ge1} n\big(\mathbb P(B_{n-1})-\mathbb P(B_n)\big)=
\sum_{n\ge0}\mathbb P(B_n).}\)</span>因此问题化为：计算所有 <span
class="math inline">\(n\)</span> 的 <span class="math inline">\(\mathbb
P(B_n)\)</span> 并求和。</p>
<p>令<span class="math inline">\(\displaystyle{x_0,x_1,\dots,x_{Y-1}\ge
0, \sum_{i=0}^{Y-1}x_i=n,}\)</span>其中 <span
class="math inline">\(x_i\)</span> 表示第 <span
class="math inline">\(i\)</span> 天生日的人数。在给定计数向量 <span
class="math inline">\(x\)</span> 时，其概率为多项分布：</p>
<p><span class="math display">\[
\mathbb P(x)=\frac{n!}{Y^n\prod_{i=0}^{Y-1} x_i!}.
\]</span></p>
<p>因此，触发条件：存在某个长度 <span class="math inline">\(w+1\)</span>
的连续区间内至少有 <span class="math inline">\(K\)</span>
人可以转换成另一种表达：对所有 <span
class="math inline">\(j\)</span>（按模 <span
class="math inline">\(Y\)</span>），都有<span
class="math inline">\(\displaystyle{\sum_{t=0}^w x_{(j+t)\%Y}\le
K-1}\)</span>。</p>
<p>因此</p>
<p><span class="math display">\[
\mathbb P(B_n)=
\sum_{\substack{x_0+\cdots+x_{Y-1}=n\\
\forall j:\sum_{t=0}^{w}x_{(j+t)\%Y}\le K-1}}
\frac{n!}{Y^n\prod_{i=0}^{Y-1} x_i!}.
\]</span></p>
<p>代入 <span class="math inline">\(\displaystyle{\mathbb
E[N]=\sum_{n\ge0}\mathbb P(B_n)}\)</span> 得</p>
<p><span class="math display">\[
\mathbb E[N]=
\sum_{\substack{x_0,\dots,x_{Y-1}\ge 0\\
\forall j:\sum_{t=0}^{w}x_{(j+t)\%Y}\le K-1}}
\frac{\big(\sum_{i=0}^{Y-1}x_i\big)!}{Y^{\sum_{i=0}^{Y-1}x_i}\prod_{i=0}^{Y-1}
x_i!}.
\]</span></p>
<p>为了简便计算，我们使用伽马函数把阶乘去除。可见，有<span
class="math inline">\(\displaystyle{n! = \int_{0}^{\infty}
e^{-u}u^ndu,}\)</span>则每个配置的贡献<span
class="math inline">\(\displaystyle{\frac{n!}{Y^n\prod_{i=0}^{Y-1}
x_i!}=\int_{0}^{\infty} e^{-u}\frac{(u/Y)^n}{\prod_{i=0}^{Y-1}
x_i!}du.}\)</span></p>
<p>交换求和与积分，得到<span class="math inline">\(\displaystyle{\mathbb
E[N]=\int_{0}^{\infty}
e^{-u}H\left(\frac{u}{Y}\right)du}\)</span>，其中<span
class="math inline">\(\displaystyle{H(z)=\sum_{\substack{x_0,\dots,x_{Y-1}\ge
0\\\forall j:\sum_{t=0}^{w}x_{j+t}\le K-1}}\frac{z^{\sum_{i=0}^{Y-1}
x_i}}{\prod_{i=0}^{Y-1} x_i!}.}\)</span></p>
<p>所以核心变成：对给定 <span class="math inline">\(z\)</span> 高效计算
<span class="math inline">\(H(z)\)</span>。</p>
<p>令<span class="math inline">\(L=w+1, B=K-1.\)</span>约束是“任意长度
<span class="math inline">\(L\)</span> 的连续窗口总和 <span
class="math inline">\(\le B\)</span>”。定义状态为最近 <span
class="math inline">\(L-1\)</span> 天的计数：<span
class="math inline">\(\displaystyle{s=(a_1,a_2,\dots,a_{L-1}), a_i\ge 0,
\sum_{i=1}^{L-1}a_i\le B.}\)</span></p>
<p>如果下一天放入 <span class="math inline">\(t\)</span>
个人，则新状态为<span
class="math inline">\(s&#39;=\text{shift}(s,t)=(a_2,a_3,\dots,a_{L-1},t),\)</span>并且必须满足窗口约束<span
class="math inline">\(\displaystyle{\sum_{i=1}^{L-1}a_i+t\le
B.}\)</span></p>
<p>每次添加 <span class="math inline">\(t\)</span> 贡献对应权重：<span
class="math inline">\(\dfrac{z^t}{t!}.\)</span>因此形成一个转移矩阵
<span class="math inline">\(T(z)\)</span>（大小为状态数 <span
class="math inline">\(S\)</span>）：</p>
<p><span class="math display">\[
T(z)_{s&#39;,s}=
\begin{cases}
\dfrac{z^t}{t!} &amp;\text{if} \quad s&#39;=\text{shift}(s,t) \land
\displaystyle{\sum_{i=1}^{L-1} a_i}+t\le B\\
0,&amp;\text{else}.
\end{cases}
\]</span></p>
<p>然而，上面的转移只保证了线性序列内部的所有长度 <span
class="math inline">\(L\)</span> 窗口都合法。</p>
<p>但一年是圆环，还需要检查跨越边界的窗口，即：</p>
<p>把开头的 <span class="math inline">\(L-1\)</span> 天记作起始状态
<span class="math inline">\(p\)</span>，末尾的 <span
class="math inline">\(L-1\)</span> 天记作结束状态 <span
class="math inline">\(e\)</span>。</p>
<p>对于每个 <span
class="math inline">\(j=1,2,\dots,L-1\)</span>，跨边界窗口包含：</p>
<ul>
<li>结束状态 <span class="math inline">\(e\)</span> 的最后 <span
class="math inline">\(j\)</span> 项</li>
<li>起始状态 <span class="math inline">\(p\)</span> 的最前 <span
class="math inline">\(L-j\)</span> 项</li>
</ul>
<p>因此必须满足<span
class="math inline">\(\displaystyle{\sum_{t=L-j}^{L-1}
e_t+\sum_{t=1}^{L-j} p_t \le B.}\)</span>记兼容矩阵<span
class="math inline">\(C_{p,e}=1\)</span>当且仅当<span
class="math inline">\((p,e)\)</span>满足所有跨边界窗口约束，否则<span
class="math inline">\(C_{p,e}=0\)</span>。</p>
<p>固定起始状态 <span class="math inline">\(p\)</span>，其自身对应前
<span class="math inline">\(L-1\)</span> 天的权重为<span
class="math inline">\(\displaystyle{W_p(z)=\frac{z^{\sum_{t=1}^{L-1}
p_t}}{\prod_{t=1}^{L-1} p_t!}.}\)</span></p>
<p>剩余的 <span class="math inline">\(Y-(L-1)\)</span>
天用矩阵推进。设<span
class="math inline">\(P(z)=T(z)^{Y-(L-1)}.\)</span>则从 <span
class="math inline">\(p\)</span> 走到 <span
class="math inline">\(e\)</span> 的总权重为 <span
class="math inline">\(P(z)_{e,p}\)</span>。</p>
<p>最后乘上首尾兼容性 <span class="math inline">\(C_{p,e}\)</span>
并对所有 <span class="math inline">\(p,e\)</span> 求和：</p>
<p><span class="math display">\[
H(z)=\sum_{p}\sum_{e} W_p(z)P(z)_{e,p}C_{p,e}.
\]</span></p>
<p>最终，我们需要 <span class="math display">\[
\mathbb E[N]=\int_{0}^{\infty} e^{-u}H\left(\frac{u}{Y}\right)du.
\]</span></p>
<p><a
target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Gauss%E2%80%93Laguerre_quadrature">Gauss–Laguerre
公式</a>直接针对权重 <span class="math inline">\(e^{-u}\)</span>：<span
class="math inline">\(\displaystyle{\int_0^\infty e^{-u} f(u),du \approx
\sum_{i=1}^{m} w_i f(x_i),}\)</span>所以只需在若干节点 <span
class="math inline">\(x_i\)</span> 处计算 <span
class="math inline">\(H(x_i/Y)\)</span> 并加权求和即可。</p>
<h2 id="代码">代码</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> fac</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_states</span>(<span class="params">m: <span class="built_in">int</span>, bound: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;All m-tuples (a0..a_&#123;m-1&#125;) with ai in [0,bound] and sum &lt;= bound.&quot;&quot;&quot;</span></span><br><span class="line">    states = []</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(bound + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">rec</span>(<span class="params">pos, rem, cur</span>):</span><br><span class="line">            <span class="keyword">if</span> pos == m:</span><br><span class="line">                <span class="keyword">if</span> rem == <span class="number">0</span>:</span><br><span class="line">                    states.append(<span class="built_in">tuple</span>(cur))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(rem + <span class="number">1</span>):</span><br><span class="line">                cur.append(x)</span><br><span class="line">                rec(pos + <span class="number">1</span>, rem - x, cur)</span><br><span class="line">                cur.pop()</span><br><span class="line"></span><br><span class="line">        rec(<span class="number">0</span>, s, [])</span><br><span class="line">    <span class="keyword">return</span> states</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare</span>(<span class="params">K: <span class="built_in">int</span>, w: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    K: required people in window (K=4)</span></span><br><span class="line"><span class="string">    w: within w days =&gt; window length L=w+1 (w=7 =&gt; L=8)</span></span><br><span class="line"><span class="string">    Y: days in year (365)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    bound = K - <span class="number">1</span></span><br><span class="line">    L = w + <span class="number">1</span></span><br><span class="line">    m = L - <span class="number">1</span>  <span class="comment"># state length, number of &quot;previous days&quot; we remember</span></span><br><span class="line"></span><br><span class="line">    states = build_states(m, bound)</span><br><span class="line">    idx = &#123;s: i <span class="keyword">for</span> i, s <span class="keyword">in</span> <span class="built_in">enumerate</span>(states)&#125;</span><br><span class="line">    S = <span class="built_in">len</span>(states)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># edges: from state j to state i by appending digit x</span></span><br><span class="line">    edges = []</span><br><span class="line">    <span class="keyword">for</span> j, s <span class="keyword">in</span> <span class="built_in">enumerate</span>(states):</span><br><span class="line">        sm = <span class="built_in">sum</span>(s)</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(bound - sm + <span class="number">1</span>):</span><br><span class="line">            ns = s[<span class="number">1</span>:] + (x,)</span><br><span class="line">            i = idx[ns]</span><br><span class="line">            edges.append((i, j, x))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compatibility matrix for wrap-around windows across end and start</span></span><br><span class="line">    <span class="comment"># C[P,E]=1 if for every j=1..m:</span></span><br><span class="line">    <span class="comment">#   sum(last j of E) + sum(first L-j of P) &lt;= bound</span></span><br><span class="line">    compat = np.zeros((S, S), dtype=np.uint8)</span><br><span class="line">    states_arr = [np.array(s, dtype=np.int16) <span class="keyword">for</span> s <span class="keyword">in</span> states]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p_idx, P <span class="keyword">in</span> <span class="built_in">enumerate</span>(states_arr):</span><br><span class="line">        P_prefix = np.concatenate([[<span class="number">0</span>], np.cumsum(P)])  <span class="comment"># P_prefix[t]=sum(P[:t])</span></span><br><span class="line">        <span class="keyword">for</span> e_idx, E <span class="keyword">in</span> <span class="built_in">enumerate</span>(states_arr):</span><br><span class="line">            E_suffix = np.concatenate([[<span class="number">0</span>], np.cumsum(E[::-<span class="number">1</span>])])  <span class="comment"># suffix sums by length</span></span><br><span class="line">            ok = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, m + <span class="number">1</span>):</span><br><span class="line">                <span class="comment"># last j from E + first (L-j) from P</span></span><br><span class="line">                <span class="keyword">if</span> E_suffix[j] + P_prefix[L - j] &gt; bound:</span><br><span class="line">                    ok = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            compat[p_idx, e_idx] = <span class="number">1</span> <span class="keyword">if</span> ok <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># start weight: z^&#123;sum(P)&#125; / prod(P_i!)</span></span><br><span class="line">    inv_fact_prod = np.zeros(S, dtype=np.float64)</span><br><span class="line">    sums = np.zeros(S, dtype=np.int16)</span><br><span class="line">    <span class="keyword">for</span> i, s <span class="keyword">in</span> <span class="built_in">enumerate</span>(states):</span><br><span class="line">        sums[i] = <span class="built_in">sum</span>(s)</span><br><span class="line">        denom = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> s:</span><br><span class="line">            denom *= fac(x)</span><br><span class="line">        inv_fact_prod[i] = <span class="number">1.0</span> / denom</span><br><span class="line"></span><br><span class="line">    inv_fact = [<span class="number">1.0</span> / fac(x) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(bound + <span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">return</span> states, edges, compat, sums, inv_fact_prod, inv_fact, m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">H_of_z</span>(<span class="params">z: <span class="built_in">float</span>, edges, compat, sums, inv_fact_prod, inv_fact, steps: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Compute H(z) = sum_&#123;valid (a_t)&#125; z^&#123;sum a_t&#125; / prod a_t!</span></span><br><span class="line"><span class="string">    via transfer matrix and wrap compatibility.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    S = <span class="built_in">len</span>(sums)</span><br><span class="line">    T = np.zeros((S, S), dtype=np.float64)</span><br><span class="line"></span><br><span class="line">    z2 = z * z</span><br><span class="line">    z3 = z2 * z</span><br><span class="line">    zp = (<span class="number">1.0</span>, z, z2, z3)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># T[next, cur] = z^x / x!</span></span><br><span class="line">    <span class="keyword">for</span> i, j, x <span class="keyword">in</span> edges:</span><br><span class="line">        T[i, j] += zp[x] * inv_fact[x]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Tpow[end, start]</span></span><br><span class="line">    Tpow = np.linalg.matrix_power(T, steps)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># For each start p:</span></span><br><span class="line">    <span class="comment"># sum over end e: Tpow[e,p] * compat[p,e]</span></span><br><span class="line">    col_sum = (Tpow * compat.T).<span class="built_in">sum</span>(axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># multiply by starting-day weight z^&#123;sum(P)&#125;/prod(P_i!)</span></span><br><span class="line">    w = inv_fact_prod * (z ** sums)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">float</span>(np.dot(w, col_sum))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expected_value</span>(<span class="params">K: <span class="built_in">int</span>, w: <span class="built_in">int</span>, Y: <span class="built_in">int</span>, quad_n: <span class="built_in">int</span> = <span class="number">40</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    E[N] = ∫_0^∞ e^&#123;-u&#125; H(u/Y) du</span></span><br><span class="line"><span class="string">    Use Gauss-Laguerre quadrature with quad_n points.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    states, edges, compat, sums, inv_fact_prod, inv_fact, m = prepare(K, w)</span><br><span class="line">    steps = Y - m</span><br><span class="line"></span><br><span class="line">    nodes, weights = np.polynomial.laguerre.laggauss(quad_n)</span><br><span class="line"></span><br><span class="line">    ans = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> x, wgt <span class="keyword">in</span> <span class="built_in">zip</span>(nodes, weights):</span><br><span class="line">        z = x / Y</span><br><span class="line">        ans += wgt * H_of_z(z, edges, compat, sums, inv_fact_prod, inv_fact, steps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ans</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Earth case: 4 people within 7 days, 365-day year</span></span><br><span class="line">    val = expected_value(K=<span class="number">4</span>, w=<span class="number">7</span>, Y=<span class="number">365</span>, quad_n=<span class="number">40</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;val:<span class="number">.8</span>f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="Ujimatsu Chiya 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="Ujimatsu Chiya 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Ujimatsu Chiya
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://ujimatsu-chiya.github.io/project-euler/584/" title="Project Euler 584">https://ujimatsu-chiya.github.io/project-euler/584/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2022 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Ujimatsu Chiya</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">25:03</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div><!-- 页面动态线条-->
<script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://lib.baomitu.com/canvas-nest.js/1.0.1/canvas-nest.js"></script>
<!-- 页面点击小红心
<script type="text/javascript" src="/js/click-love.js" />-->

<span id="sitetime"></span>
<script language=javascript>
function siteTime(){
    window.setTimeout("siteTime()", 1000);
    let seconds = 1000;
    let minutes = seconds * 60;
    let hours = minutes * 60;
    let days = hours * 24;
    let years = days * 365;
    let create_day = new Date("2022-03-25T13:14:23Z");
    let today = new Date();
    let awesome = "<i class=\"fa-solid fa-clock\"></i> "

    let diff = today-create_day;
    let diffSeconds = Math.floor(diff/seconds%60);
    let diffMinutes = Math.floor(diff/minutes%60);
    let diffHours = Math.floor(diff/hours%24);
    let diffDays = Math.floor(diff/days%365);
    let diffYears = Math.floor(diff/years);

    document.getElementById("sitetime").innerHTML=`自 ${create_day.getFullYear()} 年 ${create_day.getMonth() + 1} 月 ${create_day.getDate()} 日建立以来，本网站已运行： ${awesome} ${diffYears} 年 ${diffDays} 天 ${diffHours} 时 ${diffMinutes} 分 ${diffSeconds} 秒`;
}
siteTime();
</script>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"Ujimatsu-Chiya/Ujimatsu-Chiya.github.io-comment","issue_term":"pathname","theme":"github-light","crossorigin":"anonymous"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
